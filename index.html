<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debit Alert Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .auth-section {
            text-align: center;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .setup-instructions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .setup-instructions h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        .setup-instructions ol {
            margin-left: 20px;
            color: #856404;
        }
        .setup-instructions li {
            margin-bottom: 10px;
        }
        .setup-instructions code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .input-group {
            margin: 20px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .date-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .date-filter-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .date-filter-btn:hover {
            background: #f0f0ff;
        }
        .date-filter-btn.active {
            background: #667eea;
            color: white;
        }
        .custom-date-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .custom-date-inputs input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .summary-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .summary-card .amount {
            font-size: 32px;
            font-weight: bold;
        }
        .chart-container {
            margin: 30px 0;
            height: 400px;
        }
        .category-section {
            margin-top: 30px;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .category-name {
            font-weight: 600;
            color: #333;
        }
        .category-amount {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        .transactions-section {
            margin-top: 30px;
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-details {
            flex: 1;
        }
        .transaction-date {
            font-size: 12px;
            color: #666;
        }
        .transaction-desc {
            margin-top: 4px;
            color: #333;
        }
        .transaction-amount {
            font-weight: bold;
            color: #e74c3c;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #667eea;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .debug-section {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
        }
        .transaction-debug {
            background: #e8f4f8;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí≥ Debit Alert Tracker</h1>
            <p>Automatically analyze your spending from Gmail debit alerts</p>
        </div>

        <div class="card setup-instructions" id="setupInstructions">
            <h3>üîß Setup Instructions</h3>
            <ol>
                <li>Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                <li>Create a new project or select an existing one</li>
                <li>Enable the <strong>Gmail API</strong> (APIs & Services ‚Üí Library)</li>
                <li>Create credentials (APIs & Services ‚Üí Credentials ‚Üí Create Credentials ‚Üí OAuth client ID)</li>
                <li>Application type: <code>Web application</code></li>
                <li>Add authorized JavaScript origins: <code>http://localhost</code> and the domain you'll host this on</li>
                <li>Add authorized redirect URIs: Same as above with your file path</li>
                <li>Copy your <strong>Client ID</strong> and paste it below</li>
            </ol>
        </div>

        <div class="card">
            <div class="input-group">
                <label for="clientId">Google OAuth Client ID:</label>
                <input type="text" id="clientId" placeholder="Enter your Client ID (e.g., 123456789-abcdef.apps.googleusercontent.com)">
            </div>
            
            <div class="input-group">
                <label for="suppliersInput">Manage Suppliers (comma-separated):</label>
                <input type="text" id="suppliersInput" placeholder="e.g., osbud pharmacy, xyz supplies, abc stores">
                <button class="btn btn-secondary" onclick="updateSuppliers()" style="margin-top: 10px;">Update Suppliers</button>
            </div>
            
            <div class="auth-section">
                <button class="btn" id="authorizeBtn" onclick="handleAuthClick()">Connect Gmail Account</button>
                <button class="btn" id="signoutBtn" onclick="handleSignoutClick()" style="display:none; background:#e74c3c;">Sign Out</button>
                <button class="btn" id="refreshBtn" onclick="fetchDebitAlerts()" style="display:none; margin-left:10px;">Refresh Data</button>
            </div>
            <div id="error" class="error hidden"></div>
        </div>

        <div id="resultsContainer" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:20px;">Date Range</h2>
                <div class="date-filters">
                    <button class="date-filter-btn active" onclick="setDateFilter('today')">Today</button>
                    <button class="date-filter-btn" onclick="setDateFilter('yesterday')">Yesterday</button>
                    <button class="date-filter-btn" onclick="setDateFilter('week')">This Week</button>
                    <button class="date-filter-btn" onclick="setDateFilter('month')">This Month</button>
                    <button class="date-filter-btn" onclick="setDateFilter('year')">This Year</button>
                    <button class="date-filter-btn" onclick="setDateFilter('all')">All Time</button>
                    <div class="custom-date-inputs">
                        <input type="date" id="startDate">
                        <span>to</span>
                        <input type="date" id="endDate">
                        <button class="btn btn-secondary" onclick="applyCustomDateRange()">Apply</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Main Expenses</h3>
                        <div class="amount" id="mainExpenses">‚Ç¶0.00</div>
                        <small style="opacity: 0.8; font-size: 12px;">Excludes suppliers & internal</small>
                    </div>
                    <div class="summary-card">
                        <h3>Supplier Payments</h3>
                        <div class="amount" id="supplierTotal">‚Ç¶0.00</div>
                        <small style="opacity: 0.8; font-size: 12px;">Payments to suppliers</small>
                    </div>
                    <div class="summary-card">
                        <h3>Total Expenses</h3>
                        <div class="amount" id="totalSpent">‚Ç¶0.00</div>
                        <small style="opacity: 0.8; font-size: 12px;">Main + Suppliers</small>
                    </div>
                    <div class="summary-card">
                        <h3>Internal Transfers</h3>
                        <div class="amount" id="internalTransfers">‚Ç¶0.00</div>
                        <small style="opacity: 0.8; font-size: 12px;">Within your accounts</small>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('overview')">Overview</button>
                    <button class="tab" onclick="switchTab('trends')">Spending Trends</button>
                    <button class="tab" onclick="switchTab('categories')">Categories</button>
                    <button class="tab" onclick="switchTab('internal')">Internal Transfers</button>
                    <button class="tab" onclick="switchTab('debug')">Debug Info</button>
                </div>

                <div id="overview" class="tab-content active">
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <div id="trends" class="tab-content">
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <div id="categories" class="tab-content">
                    <div class="chart-container">
                        <canvas id="categoryBarChart"></canvas>
                    </div>
                    <div class="category-section">
                        <h2 style="margin-bottom:20px;">Spending by Category</h2>
                        <div id="categoriesContainer"></div>
                    </div>
                </div>

                <div id="internal" class="tab-content">
                    <div class="category-section">
                        <h2 style="margin-bottom:20px;">Internal Transfers</h2>
                        <p style="color: #666; margin-bottom: 20px;">These transactions are money moving within your own accounts and are not counted as expenses.</p>
                        <div id="internalTransactionsContainer"></div>
                    </div>
                </div>

                <div id="debug" class="tab-content">
                    <div class="category-section">
                        <h2 style="margin-bottom:20px;">Debug Information</h2>
                        <p style="color: #666; margin-bottom: 20px;">This shows how transactions are being categorized. Use this to find the exact keywords in your emails.</p>
                        <div id="debugContainer"></div>
                    </div>
                </div>

                <div class="transactions-section">
                    <h2 style="margin-bottom:20px;">Recent Expense Transactions</h2>
                    <div id="transactionsContainer"></div>
                </div>
            </div>
        </div>

        <div id="loading" class="card loading hidden">
            <h3>Loading your transactions...</h3>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let tokenClient;
        let accessToken = null;
        let allTransactions = [];
        let filteredTransactions = [];
        let currentFilter = 'today';
        let charts = {};

        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest';
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

        // Internal accounts/companies (NOT expenses)
        const INTERNAL_ACCOUNTS = [
            'enavec pharmacy',
            'enavec pharmaceuticals',
            'enavec',
            'iloanugo chijioke francis',
            'chijioke francis iloanugo',
            'moniepoint'
        ];

        // Supplier keywords (these ARE expenses but tracked separately)
        let SUPPLIERS = [
            'osbud pharmacy',
            'osbud pharmacy and stores',
            'osbud',
            'emzor pharmaceutical',
            'emzor',
            'juhel pharma',
            'juhel',
            'mega lifesciences',
            'mega life',
            'fidson healthcare',
            'fidson',
            'swipha',
            'drugfield pharmaceuticals',
            'drugfield',
            'medplus',
            'neimeth international',
            'neimeth',
            'chi pharmaceuticals',
            'chi pharma',
            'may & baker',
            'may and baker',
            'pharma deko',
            'swiss pharma',
            'gsk',
            'glaxo',
            'evans medical',
            'evans',
            'zolon healthcare',
            'zolon',
            'dana drugs',
            'dana'
        ];

        const CATEGORIES = {
            'Suppliers': [], // Will be populated from SUPPLIERS array
            'Food & Dining': ['restaurant', 'food', 'cafe', 'pizza', 'burger', 'kfc', 'dominos', 'bakery', 'shawarma', 'chicken republic'],
            'Transportation': ['uber', 'bolt', 'taxi', 'transport', 'fuel', 'petrol', 'gas station', 'parking'],
            'Groceries': ['shoprite', 'spar', 'market', 'grocery', 'supermarket', 'store'],
            'Utilities': ['electricity', 'water', 'phcn', 'nepa', 'dstv', 'gotv', 'startimes', 'internet', 'airtel', 'mtn', 'glo', '9mobile'],
            'Entertainment': ['cinema', 'movie', 'netflix', 'spotify', 'game', 'xbox', 'playstation'],
            'Shopping': ['jumia', 'konga', 'amazon', 'mall', 'clothing', 'fashion'],
            'Healthcare': ['hospital', 'clinic', 'doctor', 'medical']
        };

        // Load saved suppliers
        function loadSuppliers() {
            const saved = localStorage.getItem('suppliers');
            if (saved) {
                SUPPLIERS = JSON.parse(saved);
            }
            CATEGORIES['Suppliers'] = SUPPLIERS;
            updateSuppliersInput();
        }

        function saveSuppliers() {
            localStorage.setItem('suppliers', JSON.stringify(SUPPLIERS));
        }

        function updateSuppliersInput() {
            document.getElementById('suppliersInput').value = SUPPLIERS.join(', ');
        }

        loadSuppliers();

        const CATEGORY_COLORS = {
            'Suppliers': '#e74c3c',
            'Food & Dining': '#FF6384',
            'Transportation': '#36A2EB',
            'Groceries': '#FFCE56',
            'Utilities': '#4BC0C0',
            'Entertainment': '#9966FF',
            'Shopping': '#FF9F40',
            'Healthcare': '#FF6384',
            'Internal Transfer': '#95a5a6',
            'Other': '#7f8c8d'
        };

        function updateSuppliers() {
            const input = document.getElementById('suppliersInput').value;
            SUPPLIERS = input.split(',').map(s => s.trim().toLowerCase()).filter(s => s.length > 0);
            CATEGORIES['Suppliers'] = SUPPLIERS;
            
            saveSuppliers();
            
            if (allTransactions.length > 0) {
                allTransactions = allTransactions.map(t => ({
                    ...t,
                    category: categorizeTransaction(t.fullText),
                    isInternal: isInternalTransfer(t.fullText)
                }));
                applyDateFilter();
            }
            
            alert('Suppliers saved permanently! Transactions have been re-categorized.');
        }

        function isInternalTransfer(text) {
            const lowerText = text.toLowerCase();
            const matchedAccount = INTERNAL_ACCOUNTS.find(account => 
                lowerText.includes(account.toLowerCase())
            );
            
            if (matchedAccount) {
                console.log('‚úÖ INTERNAL TRANSFER matched:', matchedAccount, '| Text preview:', text.substring(0, 150));
            }
            
            return !!matchedAccount;
        }

        function categorizeTransaction(text) {
            const lowerText = text.toLowerCase();
            
            // Check suppliers first
            const matchedSupplier = SUPPLIERS.find(supplier => 
                lowerText.includes(supplier.toLowerCase())
            );
            
            if (matchedSupplier) {
                console.log('üí∞ SUPPLIER matched:', matchedSupplier, '| Text preview:', text.substring(0, 150));
                return 'Suppliers';
            }
            
            // Then check other categories
            for (const [category, keywords] of Object.entries(CATEGORIES)) {
                if (category === 'Suppliers') continue;
                
                const matchedKeyword = keywords.find(keyword => 
                    lowerText.includes(keyword.toLowerCase())
                );
                
                if (matchedKeyword) {
                    console.log('üìÇ CATEGORY matched:', category, '(', matchedKeyword, ') | Text preview:', text.substring(0, 150));
                    return category;
                }
            }
            
            console.log('‚ùì NO MATCH - categorized as Other | Text preview:', text.substring(0, 150));
            return 'Other';
        }

        function initializeGoogleAPI() {
            const clientId = document.getElementById('clientId').value.trim();
            
            if (!clientId) {
                showError('Please enter your Google OAuth Client ID');
                return false;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error !== undefined) {
                        showError(response.error);
                        return;
                    }
                    accessToken = response.access_token;
                    document.getElementById('authorizeBtn').style.display = 'none';
                    document.getElementById('signoutBtn').style.display = 'inline-block';
                    document.getElementById('refreshBtn').style.display = 'inline-block';
                    document.getElementById('setupInstructions').style.display = 'none';
                    fetchDebitAlerts();
                },
            });
            return true;
        }

        function handleAuthClick() {
            if (!initializeGoogleAPI()) return;
            
            if (accessToken === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                accessToken = null;
            }
            document.getElementById('authorizeBtn').style.display = 'inline-block';
            document.getElementById('signoutBtn').style.display = 'none';
            document.getElementById('refreshBtn').style.display = 'none';
            document.getElementById('resultsContainer').classList.add('hidden');
            allTransactions = [];
            filteredTransactions = [];
        }

        async function fetchDebitAlerts() {
            showLoading(true);
            hideError();
            console.clear();
            console.log('üîç Starting to fetch debit alerts...');

            try {
                const query = 'subject:(debit OR debited OR transaction) -credit';
                const response = await fetch(
                    `https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=200`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                const data = await response.json();
                
                if (!data.messages) {
                    showError('No debit alert emails found. Make sure your query matches your bank\'s email format.');
                    showLoading(false);
                    return;
                }

                console.log(`üìß Found ${data.messages.length} emails to process`);

                const transactions = [];
                for (const message of data.messages) {
                    const msgResponse = await fetch(
                        `https://gmail.googleapis.com/gmail/v1/users/me/messages/${message.id}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        }
                    );
                    const msgData = await msgResponse.json();
                    const transaction = parseEmailForTransaction(msgData);
                    if (transaction) {
                        transactions.push(transaction);
                    }
                }

                console.log(`‚úÖ Successfully parsed ${transactions.length} transactions`);
                allTransactions = transactions.sort((a, b) => b.date - a.date);
                applyDateFilter();
                showLoading(false);

            } catch (error) {
                showError('Error fetching emails: ' + error.message);
                showLoading(false);
            }
        }

        function parseEmailForTransaction(message) {
            const headers = message.payload.headers;
            const subject = headers.find(h => h.name === 'Subject')?.value || '';
            const date = headers.find(h => h.name === 'Date')?.value || '';
            
            let body = '';
            if (message.payload.body.data) {
                body = atob(message.payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
            } else if (message.payload.parts) {
                const textPart = message.payload.parts.find(p => p.mimeType === 'text/plain');
                if (textPart && textPart.body.data) {
                    body = atob(textPart.body.data.replace(/-/g, '+').replace(/_/g, '/'));
                }
            }

            const fullText = subject + ' ' + body;

            const amountPatterns = [
                /(?:NGN|‚Ç¶|N)\s*([\d,]+\.?\d*)/i,
                /(?:amount|amt|debited|debit).*?([\d,]+\.?\d*)/i,
                /([\d,]+\.?\d*)\s*(?:NGN|‚Ç¶|N)/i
            ];

            let amount = null;
            for (const pattern of amountPatterns) {
                const match = fullText.match(pattern);
                if (match) {
                    amount = parseFloat(match[1].replace(/,/g, ''));
                    if (amount > 0) break;
                }
            }

            if (!amount) return null;

            const isInternal = isInternalTransfer(fullText);
            const category = categorizeTransaction(fullText);

            return {
                date: new Date(date),
                description: subject.substring(0, 100),
                amount: amount,
                category: category,
                fullText: fullText,
                isInternal: isInternal
            };
        }

        function setDateFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            applyDateFilter();
        }

        function applyCustomDateRange() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (!startDate || !endDate) {
                showError('Please select both start and end dates');
                return;
            }

            endDate.setHours(23, 59, 59, 999);
            
            filteredTransactions = allTransactions.filter(t => 
                t.date >= startDate && t.date <= endDate
            );
            
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            displayResults(filteredTransactions);
        }

        function applyDateFilter() {
            const now = new Date();
            let startDate;

            switch(currentFilter) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'yesterday':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filteredTransactions = allTransactions.filter(t => 
                        t.date >= startDate && t.date < endDate
                    );
                    displayResults(filteredTransactions);
                    return;
                case 'week':
                    const dayOfWeek = now.getDay();
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'all':
                    filteredTransactions = allTransactions;
                    displayResults(filteredTransactions);
                    return;
            }

            filteredTransactions = allTransactions.filter(t => t.date >= startDate);
            displayResults(filteredTransactions);
        }

        function displayResults(transactions) {
            if (transactions.length === 0) {
                showError('No transactions found for this date range');
                document.getElementById('resultsContainer').classList.remove('hidden');
                return;
            }

            console.log('üìä Displaying results for', transactions.length, 'transactions');

            // Separate transactions by type
            const internalTransfers = transactions.filter(t => t.isInternal);
            const supplierTransactions = transactions.filter(t => !t.isInternal && t.category === 'Suppliers');
            const mainExpenses = transactions.filter(t => !t.isInternal && t.category !== 'Suppliers');
            const allExpenses = transactions.filter(t => !t.isInternal);

            console.log('üíµ Internal Transfers:', internalTransfers.length);
            console.log('üè≠ Supplier Transactions:', supplierTransactions.length);
            console.log('üí∞ Main Expenses:', mainExpenses.length);
            console.log('üìà Total Expenses:', allExpenses.length);

            // Calculate totals
            const internalTotal = internalTransfers.reduce((sum, t) => sum + t.amount, 0);
            const supplierTotal = supplierTransactions.reduce((sum, t) => sum + t.amount, 0);
            const mainTotal = mainExpenses.reduce((sum, t) => sum + t.amount, 0);
            const expenseTotal = allExpenses.reduce((sum, t) => sum + t.amount, 0);

            console.log('üí∏ Totals - Internal:', internalTotal, '| Supplier:', supplierTotal, '| Main:', mainTotal, '| Total Expenses:', expenseTotal);

            // Update summary cards
            document.getElementById('mainExpenses').textContent = `‚Ç¶${mainTotal.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
            document.getElementById('supplierTotal').textContent = `‚Ç¶${supplierTotal.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
            document.getElementById('totalSpent').textContent = `‚Ç¶${expenseTotal.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
            document.getElementById('internalTransfers').textContent = `‚Ç¶${internalTotal.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;

            // Group expenses by category
            const byCategory = {};
            allExpenses.forEach(t => {
                if (!byCategory[t.category]) {
                    byCategory[t.category] = 0;
                }
                byCategory[t.category] += t.amount;
            });

            const categoriesHtml = Object.entries(byCategory)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, amount]) => `
                    <div class="category-item">
                        <span class="category-name">${cat}</span>
                        <span class="category-amount">‚Ç¶${amount.toLocaleString('en-NG', {minimumFractionDigits: 2})}</span>
                    </div>
                `).join('');
            document.getElementById('categoriesContainer').innerHTML = categoriesHtml;

            // Display expense transactions
            const transactionsHtml = allExpenses
                .slice(0, 50)
                .map(t => `
                    <div class="transaction-item">
                        <div class="transaction-details">
                            <div class="transaction-date">${t.date.toLocaleDateString()} - ${t.category}</div>
                            <div class="transaction-desc">${t.description}</div>
                        </div>
                        <div class="transaction-amount">‚Ç¶${t.amount.toLocaleString('en-NG', {minimumFractionDigits: 2})}</div>
                    </div>
                `).join('');
            document.getElementById('transactionsContainer').innerHTML = transactionsHtml || '<p style="color: #666;">No expense transactions found.</p>';

            // Display internal transfers
            const internalHtml = internalTransfers
                .slice(0, 50)
                .map(t => `
                    <div class="transaction-item">
                        <div class="transaction-details">
                            <div class="transaction-date">${t.date.toLocaleDateString()}</div>
                            <div class="transaction-desc">${t.description}</div>
                        </div>
                        <div class="transaction-amount" style="color: #95a5a6;">‚Ç¶${t.amount.toLocaleString('en-NG', {minimumFractionDigits: 2})}</div>
                    </div>
                `).join('');
            document.getElementById('internalTransactionsContainer').innerHTML = internalHtml || '<p style="color: #666;">No internal transfers found.</p>';

            // Display debug information
            const debugHtml = transactions
                .slice(0, 20)
                .map(t => `
                    <div class="transaction-debug">
                        <strong>Amount:</strong> ‚Ç¶${t.amount.toLocaleString()}<br>
                        <strong>Type:</strong> ${t.isInternal ? 'üîÑ Internal Transfer' : (t.category === 'Suppliers' ? 'üè≠ Supplier Payment' : 'üí∞ Expense')}<br>
                        <strong>Category:</strong> ${t.category}<br>
                        <strong>Date:</strong> ${t.date.toLocaleDateString()}<br>
                        <strong>Description:</strong> ${t.description}<br>
                        <strong>Email Text Preview:</strong> ${t.fullText.substring(0, 200)}...
                    </div>
                `).join('');
            document.getElementById('debugContainer').innerHTML = debugHtml || '<p style="color: #666;">No transactions to debug.</p>';

            createCharts(allExpenses, byCategory);
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        function createCharts(transactions, byCategory) {
            Object.values(charts).forEach(chart => chart?.destroy());

            // Category Pie Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            charts.categoryChart = new Chart(categoryCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(byCategory),
                    datasets: [{
                        data: Object.values(byCategory),
                        backgroundColor: Object.keys(byCategory).map(cat => CATEGORY_COLORS[cat] || '#95a5a6')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Spending by Category',
                            font: { size: 18 }
                        }
                    }
                }
            });

            // Spending Trend Line Chart
            const trendData = prepareTimeSeriesData(transactions);
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            charts.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [{
                        label: 'Daily Spending',
                        data: trendData.values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Spending Trend Over Time',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '‚Ç¶' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            // Category Bar Chart
            const barCtx = document.getElementById('categoryBarChart').getContext('2d');
            charts.categoryBarChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(byCategory),
                    datasets: [{
                        label: 'Amount Spent',
                        data: Object.values(byCategory),
                        backgroundColor: Object.keys(byCategory).map(cat => CATEGORY_COLORS[cat] || '#95a5a6')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Spending Comparison by Category',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '‚Ç¶' + value.toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function prepareTimeSeriesData(transactions) {
            const dailySpending = {};
            
            transactions.forEach(t => {
                const dateKey = t.date.toLocaleDateString('en-US');
                dailySpending[dateKey] = (dailySpending[dateKey] || 0) + t.amount;
            });

            const sortedDates = Object.keys(dailySpending).sort((a, b) => 
                new Date(a) - new Date(b)
            );

            return {
                labels: sortedDates,
                values: sortedDates.map(date => dailySpending[date])
            };
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }
    </script>
</body>
</html>
