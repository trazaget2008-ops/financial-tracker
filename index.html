<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debit Alert Tracker</title>
    <style>
        /* All existing CSS remains unchanged */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .auth-section {
            text-align: center;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        .btn-danger {
            background: #e74c3c;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .setup-instructions {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .setup-instructions h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        .setup-instructions ol {
            margin-left: 20px;
            color: #856404;
        }
        .setup-instructions li {
            margin-bottom: 10px;
        }
        .setup-instructions code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .input-group {
            margin: 20px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .supplier-management {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .supplier-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .supplier-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .supplier-tag button {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
        }
        .supplier-tag button:hover {
            background: rgba(255,255,255,0.5);
        }
        .add-supplier-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .add-supplier-form input {
            flex: 1;
        }
        .date-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .date-filter-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        .date-filter-btn:hover {
            background: #f0f0ff;
        }
        .date-filter-btn.active {
            background: #667eea;
            color: white;
        }
        .custom-date-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .custom-date-inputs input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .summary-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        .summary-card .amount {
            font-size: 32px;
            font-weight: bold;
        }
        .chart-container {
            margin: 30px 0;
            height: 400px;
        }
        .category-section {
            margin-top: 30px;
        }
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .category-name {
            font-weight: 600;
            color: #333;
        }
        .category-amount {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        .transactions-section {
            margin-top: 30px;
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-details {
            flex: 1;
        }
        .transaction-date {
            font-size: 12px;
            color: #666;
        }
        .transaction-desc {
            margin-top: 4px;
            color: #333;
        }
        .transaction-amount {
            font-weight: bold;
            color: #e74c3c;
        }
        .transaction-category-info {
            font-size: 11px;
            color: #888;
            margin-top: 4px;
            font-style: italic;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .hidden {
            display: none;
        }
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        .tab:hover {
            color: #667eea;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’³ Debit Alert Tracker</h1>
            <p>Automatically analyze your spending from Gmail debit alerts</p>
        </div>

        <div class="card setup-instructions" id="setupInstructions">
            <h3>ðŸ”§ Setup Instructions</h3>
            <ol>
                <li>Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                <li>Create a new project or select an existing one</li>
                <li>Enable the <strong>Gmail API</strong> (APIs & Services â†’ Library)</li>
                <li>Create credentials (APIs & Services â†’ Credentials â†’ Create Credentials â†’ OAuth client ID)</li>
                <li>Application type: <code>Web application</code></li>
                <li>Add authorized JavaScript origins: <code>http://localhost</code> and the domain you'll host this on</li>
                <li>Add authorized redirect URIs: Same as above with your file path</li>
                <li>Copy your <strong>Client ID</strong> and paste it below</li>
            </ol>
        </div>

        <div class="card">
            <div class="input-group">
                <label for="clientId">Google OAuth Client ID:</label>
                <input type="text" id="clientId" placeholder="Enter your Client ID (e.g., 123456789-abcdef.apps.googleusercontent.com)">
            </div>
            <div class="auth-section">
                <button class="btn" id="authorizeBtn" onclick="handleAuthClick()">Connect Gmail Account</button>
                <button class="btn" id="signoutBtn" onclick="handleSignoutClick()" style="display:none; background:#e74c3c;">Sign Out</button>
                <button class="btn" id="refreshBtn" onclick="fetchDebitAlerts()" style="display:none; margin-left:10px;">Refresh Data</button>
            </div>
            <div id="error" class="error hidden"></div>
            
            <div class="supplier-management">
                <h3>Supplier Management</h3>
                <p style="color: #666; margin-bottom: 10px;">Add suppliers to automatically categorize their transactions. Keywords are matched flexibly.</p>
                <div class="add-supplier-form">
                    <input type="text" id="newSupplierInput" placeholder="Enter supplier name (e.g., Osbud Pharmacy)">
                    <button class="btn btn-small" onclick="addSupplier()">Add Supplier</button>
                </div>
                <div class="supplier-list" id="supplierList"></div>
            </div>
        </div>

        <div id="resultsContainer" class="hidden">
            <div class="card">
                <h2 style="margin-bottom:20px;">Date Range</h2>
                <div class="date-filters">
                    <button class="date-filter-btn active" onclick="setDateFilter('today')">Today</button>
                    <button class="date-filter-btn" onclick="setDateFilter('yesterday')">Yesterday</button>
                    <button class="date-filter-btn" onclick="setDateFilter('week')">This Week</button>
                    <button class="date-filter-btn" onclick="setDateFilter('month')">This Month</button>
                    <button class="date-filter-btn" onclick="setDateFilter('year')">This Year</button>
                    <button class="date-filter-btn" onclick="setDateFilter('all')">All Time</button>
                    <div class="custom-date-inputs">
                        <input type="date" id="startDate">
                        <span>to</span>
                        <input type="date" id="endDate">
                        <button class="btn btn-secondary" onclick="applyCustomDateRange()">Apply</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>Total Spent</h3>
                        <div class="amount" id="totalSpent">â‚¦0.00</div>
                        <p style="font-size: 12px; margin-top: 8px; opacity: 0.9;">Excludes internal transfers, suppliers & charges</p>
                    </div>
                    <div class="summary-card">
                        <h3>Transactions</h3>
                        <div class="amount" id="totalTransactions">0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Average Transaction</h3>
                        <div class="amount" id="avgTransaction">â‚¦0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3>Highest Transaction</h3>
                        <div class="amount" id="highestTransaction">â‚¦0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3>Internal Transfers</h3>
                        <div class="amount" id="internalTransfers">â‚¦0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3>Supplier Payments</h3>
                        <div class="amount" id="supplierPayments">â‚¦0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3>Bank Charges</h3>
                        <div class="amount" id="bankCharges">â‚¦0.00</div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="switchTab('overview')">Overview</button>
                    <button class="tab" onclick="switchTab('trends')">Spending Trends</button>
                    <button class="tab" onclick="switchTab('categories')">Categories</button>
                </div>

                <div id="overview" class="tab-content active">
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <div id="trends" class="tab-content">
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>

                <div id="categories" class="tab-content">
                    <div class="chart-container">
                        <canvas id="categoryBarChart"></canvas>
                    </div>
                    <div class="category-section">
                        <h2 style="margin-bottom:20px;">Spending by Category</h2>
                        <div id="categoriesContainer"></div>
                    </div>
                </div>

                <div class="transactions-section">
                    <h2 style="margin-bottom:20px;">All Transactions (with Descriptions)</h2>
                    <div id="transactionsContainer"></div>
                </div>
            </div>
        </div>

        <div id="loading" class="card loading hidden">
            <h3>Loading your transactions...</h3>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        let tokenClient;
        let accessToken = null;
        let allTransactions = [];
        let filteredTransactions = [];
        let currentFilter = 'today';
        let charts = {};
        let suppliers = ['osbud pharmacy and stores limited'];

        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest';
        const SCOPES = 'https://www.googleapis.com/auth/gmail.readonly';

        const CATEGORIES = {
            'Food & Dining': ['restaurant', 'food', 'cafe', 'pizza', 'burger', 'kfc', 'dominos', 'bakery', 'shawarma', 'chowdeck', 'chow', 'chicken', 'glovo', 'mega chicken', 'chicken republic'],
            'Transportation': ['uber', 'bolt', 'taxi', 'transport', 'fuel', 'petrol', 'gas station', 'parking'],
            'Groceries': ['shoprite', 'spar', 'market', 'grocery', 'supermarket', 'store'],
            'Utilities': ['electricity', 'water', 'phcn', 'eko','nepa', 'dstv', 'gotv', 'startimes', 'internet', 'airtel', 'mtn', 'glo', '9mobile'],
            'Entertainment': ['cinema', 'movie', 'netflix', 'spotify', 'game', 'xbox', 'playstation'],
            'Shopping': ['jumia', 'konga', 'amazon', 'mall', 'clothing', 'fashion'],
            'Healthcare': ['hospital', 'pharmacy', 'clinic', 'doctor', 'medical'],
            'Transfer': ['transfer', 'sent to', 'payment to'],
            'Internal Transfers': ['iloanugo chijioke francis','iloanugo chijioke','iloanugo chi','iloanugo c', 'iloanugo f','enavec pharmacy','enavec pharm','enavec', 'enavec pharmaceutical'],
            'Supplier Payments': [],
            'Bank Charges': ['bank charge', 'service charge', 'maintenance fee', 'commission', 'vat charge', 'stamp duty', 'sms charge', 'alert charge']
        };

        const CATEGORY_COLORS = {
            'Food & Dining': '#FF6384',
            'Transportation': '#36A2EB',
            'Groceries': '#FFCE56',
            'Utilities': '#4BC0C0',
            'Entertainment': '#9966FF',
            'Shopping': '#FF9F40',
            'Healthcare': '#FF6384',
            'Transfer': '#C9CBCF',
            'Internal Transfers': '#3498db',
            'Supplier Payments': '#e67e22',
            'Bank Charges': '#95a5a6',
            'Other': '#7f8c8d'
        };

        // Load suppliers from localStorage
        function loadSuppliers() {
            const saved = localStorage.getItem('debitTracker_suppliers');
            if (saved) {
                suppliers = JSON.parse(saved);
            }
            displaySuppliers();
        }

        // Save suppliers to localStorage
        function saveSuppliers() {
            localStorage.setItem('debitTracker_suppliers', JSON.stringify(suppliers));
        }

        // Display suppliers
        function displaySuppliers() {
            const container = document.getElementById('supplierList');
            if (suppliers.length === 0) {
                container.innerHTML = '<p style="color: #666; margin-top: 15px;">No suppliers added yet.</p>';
                return;
            }
            
            container.innerHTML = suppliers.map((supplier, index) => `
                <div class="supplier-tag">
                    <span>${supplier}</span>
                    <button onclick="removeSupplier(${index})" title="Remove">Ã—</button>
                </div>
            `).join('');
        }

        // Add supplier
        function addSupplier() {
            const input = document.getElementById('newSupplierInput');
            const supplierName = input.value.trim();
            
            if (!supplierName) {
                showError('Please enter a supplier name');
                return;
            }
            
            if (suppliers.some(s => s.toLowerCase() === supplierName.toLowerCase())) {
                showError('This supplier already exists');
                return;
            }
            
            suppliers.push(supplierName);
            saveSuppliers();
            displaySuppliers();
            input.value = '';
            hideError();
            
            // Re-categorize transactions if they exist
            if (allTransactions.length > 0) {
                allTransactions = allTransactions.map(t => ({
                    ...t,
                    category: categorizeTransaction(t.fullText),
                    categoryKeyword: getCategoryKeyword(t.fullText)
                }));
                applyDateFilter();
            }
        }

        // Remove supplier
        function removeSupplier(index) {
            if (confirm(`Remove "${suppliers[index]}" from suppliers list?`)) {
                suppliers.splice(index, 1);
                saveSuppliers();
                displaySuppliers();
                
                // Re-categorize transactions if they exist
                if (allTransactions.length > 0) {
                    allTransactions = allTransactions.map(t => ({
                        ...t,
                        category: categorizeTransaction(t.fullText),
                        categoryKeyword: getCategoryKeyword(t.fullText)
                    }));
                    applyDateFilter();
                }
            }
        }

        function initializeGoogleAPI() {
            const clientId = document.getElementById('clientId').value.trim();
            
            if (!clientId) {
                showError('Please enter your Google OAuth Client ID');
                return false;
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error !== undefined) {
                        showError(response.error);
                        return;
                    }
                    accessToken = response.access_token;
                    document.getElementById('authorizeBtn').style.display = 'none';
                    document.getElementById('signoutBtn').style.display = 'inline-block';
                    document.getElementById('refreshBtn').style.display = 'inline-block';
                    document.getElementById('setupInstructions').style.display = 'none';
                    fetchDebitAlerts();
                },
            });
            return true;
        }

        function handleAuthClick() {
            if (!initializeGoogleAPI()) return;
            
            if (accessToken === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function handleSignoutClick() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                accessToken = null;
            }
            document.getElementById('authorizeBtn').style.display = 'inline-block';
            document.getElementById('signoutBtn').style.display = 'none';
            document.getElementById('refreshBtn').style.display = 'none';
            document.getElementById('resultsContainer').classList.add('hidden');
            allTransactions = [];
            filteredTransactions = [];
        }

        async function fetchDebitAlerts() {
            showLoading(true);
            hideError();

            try {
                const query = 'subject:(debit OR debited OR transaction) -credit';
                const response = await fetch(
                    `https://gmail.googleapis.com/gmail/v1/users/me/messages?q=${encodeURIComponent(query)}&maxResults=200`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                const data = await response.json();
                
                if (!data.messages) {
                    showError('No debit alert emails found. Make sure your query matches your bank\'s email format.');
                    showLoading(false);
                    return;
                }

                const transactions = [];
                for (const message of data.messages) {
                    const msgResponse = await fetch(
                        `https://gmail.googleapis.com/gmail/v1/users/me/messages/${message.id}`,
                        {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        }
                    );
                    const msgData = await msgResponse.json();
                    const transaction = parseEmailForTransaction(msgData);
                    if (transaction) {
                        transactions.push(transaction);
                    }
                }

                allTransactions = transactions.sort((a, b) => b.date - a.date);
                applyDateFilter();
                showLoading(false);

            } catch (error) {
                showError('Error fetching emails: ' + error.message);
                showLoading(false);
            }
        }

        function parseEmailForTransaction(message) {
            const headers = message.payload.headers;
            const subject = headers.find(h => h.name === 'Subject')?.value || '';
            const date = headers.find(h => h.name === 'Date')?.value || '';
            
            let body = '';
            if (message.payload.body.data) {
                body = atob(message.payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
            } else if (message.payload.parts) {
                // Try to get both plain text and HTML parts for more data
                for (const part of message.payload.parts) {
                    if (part.mimeType === 'text/plain' || part.mimeType === 'text/html') {
                        if (part.body.data) {
                            body += ' ' + atob(part.body.data.replace(/-/g, '+').replace(/_/g, '/'));
                        }
                    }
                    // Check nested parts
                    if (part.parts) {
                        for (const subPart of part.parts) {
                            if ((subPart.mimeType === 'text/plain' || subPart.mimeType === 'text/html') && subPart.body.data) {
                                body += ' ' + atob(subPart.body.data.replace(/-/g, '+').replace(/_/g, '/'));
                            }
                        }
                    }
                }
            }

            const fullText = subject + ' ' + body;

            const amountPatterns = [
                /(?:NGN|â‚¦|N)\s*([\d,]+\.?\d*)/i,
                /(?:amount|amt|debited|debit).*?([\d,]+\.?\d*)/i,
                /([\d,]+\.?\d*)\s*(?:NGN|â‚¦|N)/i
            ];

            let amount = null;
            for (const pattern of amountPatterns) {
                const match = fullText.match(pattern);
                if (match) {
                    amount = parseFloat(match[1].replace(/,/g, ''));
                    if (amount > 0) break;
                }
            }

            if (!amount) return null;

            const category = categorizeTransaction(fullText);
            const categoryKeyword = getCategoryKeyword(fullText);

            return {
                date: new Date(date),
                description: subject.substring(0, 100),
                amount: amount,
                category: category,
                categoryKeyword: categoryKeyword,
                fullText: fullText
            };
        }

        function categorizeTransaction(text) {
            text = text.toLowerCase();
            
            // Check Supplier Payments first (highest priority)
            for (const supplier of suppliers) {
                // Check for exact supplier name match
                if (text.includes(supplier.toLowerCase())) {
                    return 'Supplier Payments';
                }
                
                // Check for partial matches (e.g., "osbud pharmacy" in "OSBUD PHARMACY AND STORES LIMITED")
                const supplierWords = supplier.toLowerCase().split(' ');
                if (supplierWords.length > 1) {
                    // Check if at least 2 words from supplier name appear in the text
                    let matchCount = 0;
                    for (const word of supplierWords) {
                        if (word.length > 3 && text.includes(word)) {
                            matchCount++;
                        }
                    }
                    if (matchCount >= 2) {
                        return 'Supplier Payments';
                    }
                }
            }
            
            // Check Internal Transfers (second priority)
            for (const keyword of CATEGORIES['Internal Transfers']) {
                if (text.includes(keyword.toLowerCase())) {
                    return 'Internal Transfers';
                }
            }
            
            // Check Bank Charges
            for (const keyword of CATEGORIES['Bank Charges']) {
                if (text.includes(keyword.toLowerCase())) {
                    return 'Bank Charges';
                }
            }
            
            // Check other categories
            for (const [category, keywords] of Object.entries(CATEGORIES)) {
                if (category === 'Internal Transfers' || category === 'Supplier Payments' || category === 'Bank Charges') {
                    continue;
                }
                for (const keyword of keywords) {
                    if (text.includes(keyword.toLowerCase())) {
                        return category;
                    }
                }
            }
            
            return 'Other';
        }

        function getCategoryKeyword(text) {
            text = text.toLowerCase();
            
            // Check Supplier Payments first (highest priority)
            for (const supplier of suppliers) {
                if (text.includes(supplier.toLowerCase())) {
                    return supplier;
                }
                
                // Check for partial matches
                const supplierWords = supplier.toLowerCase().split(' ');
                if (supplierWords.length > 1) {
                    let matchCount = 0;
                    let matchedWords = [];
                    for (const word of supplierWords) {
                        if (word.length > 3 && text.includes(word)) {
                            matchCount++;
                            matchedWords.push(word);
                        }
                    }
                    if (matchCount >= 2) {
                        return matchedWords.join(' ');
                    }
                }
            }
            
            // Check Internal Transfers (second priority)
            for (const keyword of CATEGORIES['Internal Transfers']) {
                if (text.includes(keyword.toLowerCase())) {
                    return keyword;
                }
            }
            
            // Check Bank Charges
            for (const keyword of CATEGORIES['Bank Charges']) {
                if (text.includes(keyword.toLowerCase())) {
                    return keyword;
                }
            }
            
            // Check other categories
            for (const [category, keywords] of Object.entries(CATEGORIES)) {
                if (category === 'Internal Transfers' || category === 'Supplier Payments' || category === 'Bank Charges') {
                    continue;
                }
                for (const keyword of keywords) {
                    if (text.includes(keyword.toLowerCase())) {
                        return keyword;
                    }
                }
            }
            
            return 'No specific keyword matched';
        }

        function setDateFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            applyDateFilter();
        }

        function applyCustomDateRange() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (!startDate || !endDate) {
                showError('Please select both start and end dates');
                return;
            }

            endDate.setHours(23, 59, 59, 999);
            
            filteredTransactions = allTransactions.filter(t => 
                t.date >= startDate && t.date <= endDate
            );
            
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            displayResults(filteredTransactions);
        }

        function applyDateFilter() {
            const now = new Date();
            let startDate;

            switch(currentFilter) {
                case 'today':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    break;
                case 'yesterday':
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    const endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filteredTransactions = allTransactions.filter(t => 
                        t.date >= startDate && t.date < endDate
                    );
                    displayResults(filteredTransactions);
                    return;
                case 'week':
                    const dayOfWeek = now.getDay();
                    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - dayOfWeek);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'all':
                    filteredTransactions = allTransactions;
                    displayResults(filteredTransactions);
                    return;
            }

            filteredTransactions = allTransactions.filter(t => t.date >= startDate);
            displayResults(filteredTransactions);
        }

        function displayResults(transactions) {
            if (transactions.length === 0) {
                showError('No transactions found for this date range');
                document.getElementById('resultsContainer').classList.remove('hidden');
                return;
            }

            // Calculate totals excluding internal transfers, supplier payments, and bank charges
            const excludedCategories = ['Internal Transfers', 'Supplier Payments', 'Bank Charges'];
            const spendingTransactions = transactions.filter(t => !excludedCategories.includes(t.category));
            const total = spendingTransactions.reduce((sum, t) => sum + t.amount, 0);
            const avg = spendingTransactions.length > 0 ? total / spendingTransactions.length : 0;
            const highest = spendingTransactions.length > 0 ? Math.max(...spendingTransactions.map(t => t.amount)) : 0;

            // Calculate separate totals for excluded categories
            const internalTotal = transactions.filter(t => t.category === 'Internal Transfers').reduce((sum, t) => sum + t.amount, 0);
            const supplierTotal = transactions.filter(t => t.category === 'Supplier Payments').reduce((sum, t) => sum + t.amount, 0);
            const chargesTotal = transactions.filter(t => t.category === 'Bank Charges').reduce((sum, t) => sum + t.amount, 0);

            const byCategory = {};
            transactions.forEach(t => {
                if (!byCategory[t.category]) {
                    byCategory[t.category] = 0;
                }
                byCategory[t.category] += t.amount;
            });

            document.getElementById('totalSpent').textContent = `â‚¦${total.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
            document.getElementById('totalTransactions').textContent = transactions.length;
            document.getElementById('avgTransaction').textContent = `â‚¦${avg.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
            document.getElementById('highestTransaction').textContent = `â‚¦${highest.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
            document.getElementById('internalTransfers').textContent = `â‚¦${internalTotal.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
            document.getElementById('supplierPayments').textContent = `â‚¦${supplierTotal.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;
            document.getElementById('bankCharges').textContent = `â‚¦${chargesTotal.toLocaleString('en-NG', {minimumFractionDigits: 2})}`;

            const categoriesHtml = Object.entries(byCategory)
                .sort((a, b) => b[1] - a[1])
                .map(([cat, amount]) => `
                    <div class="category-item">
                        <span class="category-name">${cat}</span>
                        <span class="category-amount">â‚¦${amount.toLocaleString('en-NG', {minimumFractionDigits: 2})}</span>
                    </div>
                `).join('');
            document.getElementById('categoriesContainer').innerHTML = categoriesHtml;

            const transactionsHtml = transactions
                .map(t => `
                    <div class="transaction-item">
                        <div class="transaction-details">
                            <div class="transaction-date">${t.date.toLocaleDateString()} - ${t.category}</div>
                            <div class="transaction-desc">${t.description}</div>
                            <div class="transaction-category-info">Categorized based on: "${t.categoryKeyword}"</div>
                        </div>
                        <div class="transaction-amount">â‚¦${t.amount.toLocaleString('en-NG', {minimumFractionDigits: 2})}</div>
                    </div>
                `).join('');
            document.getElementById('transactionsContainer').innerHTML = transactionsHtml;

            createCharts(transactions, byCategory);
            document.getElementById('resultsContainer').classList.remove('hidden');
        }

        function createCharts(transactions, byCategory) {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart?.destroy());

            // Category Pie Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            charts.categoryChart = new Chart(categoryCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(byCategory),
                    datasets: [{
                        data: Object.values(byCategory),
                        backgroundColor: Object.keys(byCategory).map(cat => CATEGORY_COLORS[cat] || '#7f8c8d')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Spending by Category',
                            font: { size: 18 }
                        }
                    }
                }
            });

            // Spending Trend Line Chart
            const trendData = prepareTimeSeriesData(transactions);
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            charts.trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [{
                        label: 'Daily Spending',
                        data: trendData.values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Spending Trend Over Time',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => 'â‚¦' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            // Category Bar Chart
            const barCtx = document.getElementById('categoryBarChart').getContext('2d');
            charts.categoryBarChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(byCategory),
                    datasets: [{
                        label: 'Amount Spent',
                        data: Object.values(byCategory),
                        backgroundColor: Object.keys(byCategory).map(cat => CATEGORY_COLORS[cat] || '#7f8c8d')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Spending Comparison by Category',
                            font: { size: 18 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => 'â‚¦' + value.toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        function prepareTimeSeriesData(transactions) {
            const dailySpending = {};
            
            transactions.forEach(t => {
                const dateKey = t.date.toLocaleDateString('en-US');
                dailySpending[dateKey] = (dailySpending[dateKey] || 0) + t.amount;
            });

            const sortedDates = Object.keys(dailySpending).sort((a, b) => 
                new Date(a) - new Date(b)
            );

            return {
                labels: sortedDates,
                values: sortedDates.map(date => dailySpending[date])
            };
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        // Initialize suppliers on page load
        window.addEventListener('load', loadSuppliers);
    </script>
</body>
</html>
